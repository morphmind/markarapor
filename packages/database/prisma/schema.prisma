// MarkaRapor Database Schema
// PostgreSQL with Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTH MODELS (NextAuth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For email/password auth
  role          UserRole  @default(USER)
  locale        String    @default("tr")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  workspaceMembers WorkspaceMember[]
  createdWorkflows Workflow[]        @relation("WorkflowCreator")
  createdReports   Report[]          @relation("ReportCreator")
  activityLogs     ActivityLog[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============================================
// WORKSPACE & TEAM
// ============================================

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  plan        Plan     @default(FREE)
  credits     Int      @default(50)
  settings    Json?    // Encrypted API keys and workspace settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     WorkspaceMember[]
  brands      Brand[]
  connections Connection[]
  workflows   Workflow[]
  reports     Report[]
  billing     Billing?

  @@index([slug])
}

model WorkspaceMember {
  id          String          @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole   @default(MEMBER)
  invitedAt   DateTime        @default(now())
  joinedAt    DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

enum Plan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// BRAND & CONNECTIONS
// ============================================

model Brand {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  slug          String
  website       String?
  logo          String?
  primaryColor  String?  @default("#3B82F6")
  secondaryColor String? @default("#1E40AF")
  industry      String?
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  connections   BrandConnection[]
  workflows     Workflow[]
  reports       Report[]
  activities    ActivityLog[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
}

model Connection {
  id             String           @id @default(cuid())
  workspaceId    String
  name           String
  provider       ConnectionProvider
  accessToken    String           @db.Text  // Encrypted
  refreshToken   String?          @db.Text  // Encrypted
  tokenExpiresAt DateTime?
  accountId      String?          // e.g., Google Ads Customer ID
  accountName    String?          // e.g., Account display name
  metadata       Json?            // Provider-specific data
  status         ConnectionStatus @default(ACTIVE)
  lastTestedAt   DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  workspace     Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brandConnections BrandConnection[]

  @@index([workspaceId])
  @@index([provider])
}

model BrandConnection {
  id           String     @id @default(cuid())
  brandId      String
  connectionId String
  propertyId   String?    // e.g., GA4 Property ID, GSC Site URL
  propertyName String?
  isDefault    Boolean    @default(false)
  createdAt    DateTime   @default(now())

  brand      Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([brandId, connectionId, propertyId])
  @@index([brandId])
  @@index([connectionId])
}

enum ConnectionProvider {
  GOOGLE_ADS
  GOOGLE_ANALYTICS
  GOOGLE_SEARCH_CONSOLE
  GOOGLE_SLIDES
  GOOGLE_SHEETS
  GOOGLE_DRIVE
}

enum ConnectionStatus {
  ACTIVE
  EXPIRED
  REVOKED
  ERROR
}

// ============================================
// WORKFLOW SYSTEM
// ============================================

model Workflow {
  id           String         @id @default(cuid())
  workspaceId  String
  brandId      String
  createdById  String
  name         String
  description  String?
  nodes        Json           // React Flow nodes
  edges        Json           // React Flow edges
  variables    Json?          // Workflow variables
  schedule     Json?          // Cron schedule config
  isActive     Boolean        @default(true)
  isTemplate   Boolean        @default(false)
  templateId   String?        // If created from template
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace    Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand        Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  createdBy    User           @relation("WorkflowCreator", fields: [createdById], references: [id])
  runs         WorkflowRun[]
  reports      Report[]

  @@index([workspaceId])
  @@index([brandId])
  @@index([createdById])
}

model WorkflowRun {
  id           String            @id @default(cuid())
  workflowId   String
  status       WorkflowRunStatus @default(PENDING)
  triggeredBy  TriggerType       @default(MANUAL)
  nodeResults  Json?             // Results from each node
  error        String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?
  creditsUsed  Int               @default(0)

  workflow     Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  report       Report?

  @@index([workflowId])
  @@index([status])
}

enum WorkflowRunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum TriggerType {
  MANUAL
  SCHEDULED
  WEBHOOK
  API
}

// ============================================
// REPORTS
// ============================================

model Report {
  id           String       @id @default(cuid())
  workspaceId  String
  brandId      String
  workflowId   String?
  workflowRunId String?     @unique
  createdById  String
  title        String
  type         ReportType
  periodStart  DateTime
  periodEnd    DateTime
  data         Json         // Report data & sections
  insights     Json?        // AI-generated insights
  status       ReportStatus @default(DRAFT)
  shareToken   String?      @unique
  shareExpires DateTime?
  isPublic     Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brand        Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  workflow     Workflow?    @relation(fields: [workflowId], references: [id])
  workflowRun  WorkflowRun? @relation(fields: [workflowRunId], references: [id])
  createdBy    User         @relation("ReportCreator", fields: [createdById], references: [id])
  exports      ReportExport[]

  @@index([workspaceId])
  @@index([brandId])
  @@index([workflowId])
  @@index([shareToken])
}

model ReportExport {
  id        String       @id @default(cuid())
  reportId  String
  format    ExportFormat
  fileUrl   String       // Storage URL
  fileSize  Int          // Bytes
  createdAt DateTime     @default(now())

  report    Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

enum ReportType {
  PERFORMANCE
  SEO
  ADS
  ANALYTICS
  COMBINED
  AUDIT
  CUSTOM
}

enum ReportStatus {
  DRAFT
  GENERATING
  READY
  FAILED
}

enum ExportFormat {
  PDF
  DOCX
  XLSX
  PPTX
  HTML
}

// ============================================
// ACTIVITY LOG
// ============================================

model ActivityLog {
  id          String       @id @default(cuid())
  brandId     String
  userId      String
  category    ActivityCategory
  title       String
  description String?
  metadata    Json?
  performedAt DateTime     @default(now())

  brand       Brand        @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([userId])
  @@index([performedAt])
}

enum ActivityCategory {
  SEO
  ADS
  CONTENT
  SOCIAL
  TECHNICAL
  ANALYTICS
  OTHER
}

// ============================================
// BILLING
// ============================================

model Billing {
  id                   String   @id @default(cuid())
  workspaceId          String   @unique
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?
  status               BillingStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  workspace            Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invoices             Invoice[]
}

model Invoice {
  id              String        @id @default(cuid())
  billingId       String
  stripeInvoiceId String        @unique
  amountDue       Int           // Cents
  amountPaid      Int
  currency        String        @default("TRY")
  status          InvoiceStatus
  invoiceUrl      String?
  invoicePdf      String?
  periodStart     DateTime
  periodEnd       DateTime
  createdAt       DateTime      @default(now())

  billing         Billing       @relation(fields: [billingId], references: [id], onDelete: Cascade)

  @@index([billingId])
}

enum BillingStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// ============================================
// SYSTEM SETTINGS (Admin Panel)
// ============================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text  // Encrypted for sensitive data
  type      SettingType
  isSecret  Boolean  @default(false)
  updatedAt DateTime @updatedAt

  @@index([key])
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  SECRET
}

// ============================================
// WORKFLOW TEMPLATES
// ============================================

model WorkflowTemplate {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  category    String
  thumbnail   String?
  nodes       Json
  edges       Json
  variables   Json?
  isPremium   Boolean  @default(false)
  isPublic    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([slug])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        Json?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  WORKFLOW_COMPLETED
  WORKFLOW_FAILED
  REPORT_READY
  CONNECTION_EXPIRED
  CREDITS_LOW
  SYSTEM
}
